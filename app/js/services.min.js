"use strict";var accessibleServices=angular.module("hkAccessibleServices",["ngStorage"]);accessibleServices.value("version","0.2").value("author","Connie Leung"),accessibleServices.factory("Accessible",["$http","$q","$translate",function(a,b,c){var d=function(a){if(null!=a&&-1==a.indexOf("http://")&&(a="http://"+a),null!=a&&0!=a.indexOf("http://")){var b=a.indexOf("http://");a=a.substring(b)}return a},e=function(a){var b=_.map(a,function(a){var b="http://accessguide.hk/wp-content/uploads/2013/11/",c=a["#text"];return _.isEqual(c,"P2")?[{imgCode:"P1",descCode:"P2",imgUrl:b+"P1.jpg"},{imgCode:"W2",descCode:"P2",imgUrl:b+"W2.jpg"}]:[{imgCode:c,descCode:c,imgUrl:b+c+".jpg"}]});return _.flatten(b)},f="http://accessguide.hk/wp-content/uploads/2013/11/",g=[{logo:"<img src='"+f+"W0.jpg' class='multiSelect' />",imgCode:"W0",desc:"(Facilities inaccessible to wheelchair users)",ticked:!1},{logo:"<img src='"+f+"W1.jpg' class='multiSelect' />",imgCode:"W1",desc:"(Facilities accessible to wheelchair users but not up to local design standard)",ticked:!1},{logo:"<img src='"+f+"W2.jpg' class='multiSelect' />",imgCode:"W2",desc:"(Facilities accessible to wheelchair users and meeting local design standard)",ticked:!1},{logo:"<img src='"+f+"H.jpg' class='multiSelect' />",imgCode:"H",desc:"(Facilities available for hearing impaired persons)",ticked:!1},{logo:"<img src='"+f+"V.jpg' class='multiSelect' />",imgCode:"V",desc:"(Facilities available for visually impaired persons)",ticked:!1},{logo:"<img src='"+f+"P1.jpg' class='multiSelect' />",imgCode:"P1",desc:"(Parking facilities available)",ticked:!1},{logo:"<img src='"+f+"L.jpg' class='multiSelect' />",imgCode:"L",desc:"(Locked)",ticked:!1}];return{get:function(c,f){var h=b.defer(),i=[],j=[],k=[],l=[],m=[],n={data:[],access_obj:[],service_area:[],category:{original:[],current:[]}};return a({method:"GET",url:c}).success(function(a){f&&(i=a[f].locations,angular.forEach(i,function(a){if(a.name_en=a["name-en"],a.address_en=a["address-en"],a.phone_number=a["phone-number"],a.url_en=d(a["url-en"]),a.url_hk=d(a["url-zh-hk"]),a.name_en=a.name_en.replace("\u2019","'"),a.name_zh_hk=a["name-zh-hk"],"art-performance-centres"===a.catergory||"art-performance-center"==a.catergory?a.catergory="arts-and-performance-centres":"computer-centres"===a.catergory?a.catergory="computer-centre":"church"===a.catergory&&(a.catergory="church1"),a.exploreImage="",a.geo={lat:0,lng:0},_.contains(_.pluck(j,"name"),a.catergory)===!1)j.push({name:a.catergory,count:1}),m.push({name:a.catergory,count:1});else{var c=_.find(j,function(b){return _.isEqual(b.name,a.catergory)});c.count=c.count+1}_.each(a.accessible,function(b,c){var d=b;_.isEqual(_.isArray(b),!1)&&(d=[b]),a.accessible[c]=e(d)}),k=_.union(k,_.keys(a.accessible))}),k=k.sort(),_.each(k,function(a){l[a]=[],_.each(g,function(b){var c=_.extend({},b);l[a].push(c)})})),n={data:i,access_obj:l,service_area:k,category:{original:m,current:j}},h.resolve(n)}).error(function(){h.reject(n)}),h.promise},translateAccessDesc:function(a,b){return _.each(a,function(a){_.each(b[a],function(a){a.desc="("+c.instant(a.imgCode)+")"})}),b}}}]).factory("MatchCriteria",["filterFilter",function(a){return{match:function(b,c){var d={};return _.isUndefined(c.name_en)||""!=c.name_en&&(d.name_en=c.name_en),_.isUndefined(c.address_en)||""!=c.address_en&&(d.address_en=c.address_en),_.isUndefined(c.phone_number)||""!=c.phone_number&&(d.phone_number=c.phone_number),a(b,d)},filterCategory:function(a,b){var c=[];return _.isUndefined(a)?c:c=_.filter(a,function(a){return _.isEqual(b[a.catergory],!0)})},filterAccessibility:function(a,b,c){if(_.isUndefined(a))return[];var d=_.filter(a,function(a){var d=a.accessible,e=_.every(b,function(a){if(_.isEqual(_.has(c,a),!0)){var b=_.pluck(c[a],"imgCode");if(b.length>0){if(_.isEqual(_.has(d,a),!0)){var e=_.pluck(d[a],"imgCode");return _.isEqual(_.isEmpty(_.intersection(e,b)),!1)}return!1}}return!0});return e});return d},countCategoryElement:function(a,b){var c=_.map(b,function(a){return{name:a.name,count:0}});return _.each(a,function(a){if(_.isEqual(_.contains(c,a.catergory),!0))arrCategoryName.push({name:a.category,count:1});else{var b=_.find(c,function(b){return b.name===a.catergory});b.count=b.count+1}}),c}}}]).factory("GetAddress",["$q","$http",function(a,b){return{getAddressNamesByKey:function(c){var d="facilities/attractions.json";_.isEqual(c,"attraction")&&(d="facilities/attractions.json"),_.isEqual(c,"shopping")&&(d="facilities/shoppings.json"),_.isEqual(c,"hotel")&&(d="facilities/hotels.json"),_.isEqual(c,"other")&&(d="facilities/other_venues.json");var e=a.defer();return b.get(d).success(function(a){var b=[];if(a){var c=void 0;a.attractions&&(c=a.attractions.locations),a.hotels&&(c=a.hotels.locations),a["shopping-dining"]&&(c=a["shopping-dining"].locations),a["other-venues"]&&(c=a["other-venues"].locations);var d=_.filter(c,function(a){return _.isEqual(_.isNull(a["address-en"]),!1)&&_.isEqual(_.isEmpty(a["address-en"]),!1)});b=_.map(d,function(a){return{address_en:a["address-en"]+", Hong Kong",address_zh_hk:a["address-zh-hk"],name_en:a["name-en"],name_zh_hk:a["name-zh-hk"]}})}e.resolve(b)}).error(function(){e.reject([])}),e.promise}}}]).factory("GeocoderCache",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=200,h=function(){var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address},function(i,j){if(j===google.maps.GeocoderStatus.OK){var k={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address,name_en:b.name_en,name_zh_hk:b.name_zh_hk,address:b.address,address_zh_hk:b.address_zh_hk};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?g+=100:j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));f.length&&(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?c(h,g):c(h,0)),d.$$phase||d.$apply()})};return{geocodeAddress:function(a){var c=b.defer();return a.address_en in e?c.resolve(e[a.address_en]):(f.push({address:a.address_en,address_zh_hk:a.address_zh_hk,name_en:a.name_en,name_zh_hk:a.name_zh_hk,d:c}),1===f.length&&h()),c.promise}}}]).factory("PlaceExplorer",["$http","$q","GeocoderCache",function(a,b,c){var d="WYNS11XAUSZMO2SAJJ5TDNZYZ4YZMYID4NY1FDBSNTF0PARA",e="LDL3PMW1XTKFJDSWVB3JPAH3J4J2Q1HYVSI2VX5WBCRXYI5G",f="20140630",g="https://api.foursquare.com/v2/venues/explore?callback=JSON_CALLBACK&v="+f+"&client_id="+d+"&client_secret="+e+"&venuePhotos=1&limit=1&ll=",h="180x180",i=function(d,e){var f=b.defer(),i=d;return _.isNull(e)||_.isUndefined(e)?f.reject({url:"",loc:i,lat:"N/A",lng:"N/A"}):(c.geocodeAddress(e).then(function(b){var c=g+b.lat+","+b.lng;a.jsonp(c).success(function(a){if(_.isEqual(_.isNull(a),!1)){var c=a.response.groups[0].items[0].venue.photos.groups[0].items[0],d=c.prefix+h+c.suffix,e={url:d,loc:i,lat:parseFloat(b.lat).toFixed(4),lng:parseFloat(b.lng).toFixed(4)};f.resolve(e)}else{console.log("no image: ["+b.address+"]");var e={url:"",loc:i,lat:"N/A",lng:"N/A"};f.resolve(e)}}).error(function(){console.log("Error in PlaceExplorer Service get method."),f.reject({url:"",loc:i,lat:"N/A",lng:"N/A"})})},function(){f.reject({url:"",loc:i,lat:"N/A",lng:"N/A"})}),f.promise)};return{getImageUrl:i}}]);